---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import FormattedDate from '../../layouts/shortcodes/FormattedDate.astro';
import Layout from '../../layouts/Layout.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const POSTS_PER_PAGE = 6;

const allPosts = (await getCollection('blog'))
	.filter((post) => !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Featured 포스트 분리 (복수 가능)
const featuredPosts = allPosts.filter((post) => post.data.featured);

// 페이지네이션
const currentPage = 1;
const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

// 모든 태그와 각 태그별 포스트 수 계산
const tagCounts = allPosts.reduce((acc, post) => {
	post.data.tags.forEach((tag) => {
		acc[tag] = (acc[tag] || 0) + 1;
	});
	return acc;
}, {} as Record<string, number>);

const allTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION} mainVariant="wide">
	{
		allTags.length > 0 && (
			<section class="tags-section">
				<div class="tags-filter">
					<button class="tag-btn active" data-tag="all">
						All <span class="tag-count">{allPosts.length}</span>
					</button>
					{allTags.map(([tag, count]) => (
						<button class="tag-btn" data-tag={tag}>
							{tag} <span class="tag-count">{count}</span>
						</button>
					))}
				</div>
			</section>
		)
	}

	{
		featuredPosts.length > 0 && (
			<section class="featured-section">
				<h2 class="section-title">
					Featured Post
					<span class="section-subtitle">추천 글</span>
				</h2>
				<div class="featured-carousel">
					<div class="carousel-container">
						<div class="carousel-track" id="carousel-track">
							{featuredPosts.map((post) => (
								<article class="featured-post" data-tags={JSON.stringify(post.data.tags)}>
									<a href={`/blog/${post.id}/`} class="featured-link">
										<div class="featured-image">
											<span class="featured-badge">Featured</span>
											{post.data.heroImage ? (
												<Image
													width={1200}
													height={600}
													src={post.data.heroImage}
													alt={post.data.title}
													class="featured-img"
												/>
											) : (
												<div class="featured-img-placeholder" />
											)}
										</div>
										<div class="featured-content">
											<h3 class="featured-title">{post.data.title}</h3>
											<div class="featured-meta">
												<time class="featured-date">
													<FormattedDate date={post.data.pubDate} />
												</time>
												{post.data.tags.length > 0 && (
													<div class="featured-tags">
														{post.data.tags.map((tag) => (
															<span class="featured-tag">#{tag}</span>
														))}
													</div>
												)}
											</div>
										</div>
									</a>
								</article>
							))}
						</div>
					</div>
					{featuredPosts.length > 1 && (
						<div class="carousel-dots" id="carousel-dots">
							{featuredPosts.map((_, index) => (
								<button
									class={`carousel-dot ${index === 0 ? 'active' : ''}`}
									data-index={index}
									aria-label={`Go to slide ${index + 1}`}
								/>
							))}
						</div>
					)}
				</div>
			</section>
		)
	}

	<section class="blog-list">
		<h2 class="section-title">
			Latest Posts
			<span class="section-subtitle">최신 글 {allPosts.length}개</span>
		</h2>

		<div class="posts-grid" id="posts-container">
			{
				allPosts.map((post, index) => (
					<article
						class="post-card"
						data-tags={JSON.stringify(post.data.tags)}
						style={index >= POSTS_PER_PAGE ? 'display: none;' : ''}
					>
						<a href={`/blog/${post.id}/`} class="card-link">
							<div class="card-image">
								{post.data.heroImage ? (
									<Image
										width={400}
										height={240}
										src={post.data.heroImage}
										alt={post.data.title}
										class="card-img"
									/>
								) : (
									<div class="card-img-placeholder" />
								)}
							</div>
							<div class="card-content">
								<time class="card-date">
									<FormattedDate date={post.data.pubDate} />
								</time>
								<h3 class="card-title">{post.data.title}</h3>
								{post.data.description && (
									<p class="card-description">{post.data.description}</p>
								)}
								{post.data.tags.length > 0 && (
									<div class="card-tags">
										{post.data.tags.map((tag) => (
											<span class="post-tag">#{tag}</span>
										))}
									</div>
								)}
							</div>
						</a>
					</article>
				))
			}
		</div>

		{
			totalPages > 1 && (
				<nav class="pagination" aria-label="Pagination">
					<button class="pagination-btn" id="prev-page" data-page={currentPage - 1} aria-label="Previous page">
						← Previous
					</button>
					<div class="pagination-numbers" id="pagination-numbers">
						{Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
							<button
								class={`pagination-number ${page === currentPage ? 'active' : ''}`}
								data-page={page}
								aria-label={`Page ${page}`}
								aria-current={page === currentPage ? 'page' : undefined}
							>
								{page}
							</button>
						))}
					</div>
					<button
						class="pagination-btn"
						id="next-page"
						data-page={currentPage + 1}
						aria-label="Next page"
					>
						Next →
					</button>
				</nav>
			)
		}
	</section>

	<script define:vars={{ totalPages, POSTS_PER_PAGE }}>
		document.addEventListener('DOMContentLoaded', () => {
			let currentPage = 1;
			let currentTag = 'all';
			const allPostElements = Array.from(document.querySelectorAll('.post-card'));

			// Tag filtering
			const tagButtons = document.querySelectorAll('.tag-btn');

			tagButtons.forEach((button) => {
				button.addEventListener('click', () => {
					currentTag = button.dataset.tag;
					currentPage = 1; // Reset to page 1 when filtering

					// 활성 버튼 변경
					tagButtons.forEach((btn) => btn.classList.remove('active'));
					button.classList.add('active');

					updatePosts();
				});
			});

			// Pagination
			const prevPageBtn = document.getElementById('prev-page');
			const nextPageBtn = document.getElementById('next-page');
			const paginationNumbers = document.getElementById('pagination-numbers');

			if (paginationNumbers) {
				const pageButtons = paginationNumbers.querySelectorAll('.pagination-number');

				pageButtons.forEach((button) => {
					button.addEventListener('click', () => {
						currentPage = parseInt(button.dataset.page);
						updatePosts();
					});
				});
			}

			if (prevPageBtn) {
				prevPageBtn.addEventListener('click', () => {
					if (currentPage > 1) {
						currentPage--;
						updatePosts();
					}
				});
			}

			if (nextPageBtn) {
				nextPageBtn.addEventListener('click', () => {
					const filteredPosts = getFilteredPosts();
					const maxPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
					if (currentPage < maxPages) {
						currentPage++;
						updatePosts();
					}
				});
			}

			function getFilteredPosts() {
				if (currentTag === 'all') {
					return allPostElements;
				}
				return allPostElements.filter((card) => {
					const cardTags = JSON.parse(card.dataset.tags || '[]');
					return cardTags.includes(currentTag);
				});
			}

			function updatePosts() {
				const filteredPosts = getFilteredPosts();
				const maxPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
				const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
				const endIndex = startIndex + POSTS_PER_PAGE;

				// Hide all posts first
				allPostElements.forEach((card) => {
					card.style.display = 'none';
				});

				// Show only paginated filtered posts
				filteredPosts.forEach((card, index) => {
					if (index >= startIndex && index < endIndex) {
						card.style.display = '';
					}
				});

				// Update pagination buttons
				if (paginationNumbers) {
					const pageButtons = paginationNumbers.querySelectorAll('.pagination-number');
					pageButtons.forEach((button, index) => {
						const pageNum = index + 1;
						button.classList.toggle('active', pageNum === currentPage);
						// Hide buttons beyond max pages
						button.style.display = pageNum <= maxPages ? '' : 'none';
					});
				}

				if (prevPageBtn) {
					prevPageBtn.disabled = currentPage === 1;
				}

				if (nextPageBtn) {
					nextPageBtn.disabled = currentPage >= maxPages;
				}

				// Scroll to top of posts
				document.querySelector('.blog-list')?.scrollIntoView({ behavior: 'smooth' });
			}

			// Carousel functionality
			const track = document.getElementById('carousel-track');
			const dotsContainer = document.getElementById('carousel-dots');

			if (track && dotsContainer) {
				let currentIndex = 0;
				const slides = track.children;
				const totalSlides = slides.length;
				const dots = dotsContainer.querySelectorAll('.carousel-dot');

				function updateCarousel() {
					track.style.transform = `translateX(-${currentIndex * 100}%)`;
					dots.forEach((dot, index) => {
						dot.classList.toggle('active', index === currentIndex);
					});
				}

				dots.forEach((dot) => {
					dot.addEventListener('click', () => {
						currentIndex = parseInt(dot.dataset.index);
						updateCarousel();
					});
				});

				// Auto-play
				setInterval(() => {
					currentIndex = (currentIndex + 1) % totalSlides;
					updateCarousel();
				}, 5000);
			}
		});
	</script>

	<style>
		.tags-section {
			margin-bottom: 3rem;
			padding-bottom: 2rem;
			border-bottom: 2px solid #e5e7eb;
		}

		.tags-filter {
			display: flex;
			flex-wrap: wrap;
			gap: 0.75rem;
		}

		.featured-section {
			margin-bottom: 4rem;
			padding-bottom: 3rem;
			border-bottom: 2px solid #e5e7eb;
		}

		.blog-list {
			margin-bottom: 4rem;
		}

		.tag-btn {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;
			padding: 0.5rem 1rem;
			background: #f3f4f6;
			border: 1px solid #e5e7eb;
			border-radius: 9999px;
			font-size: 0.875rem;
			font-weight: 500;
			color: #6b7280;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.tag-btn:hover {
			background: #e5e7eb;
			color: #374151;
		}

		.tag-btn.active {
			background: #2563eb;
			border-color: #2563eb;
			color: #fff;
		}

		.tag-count {
			font-size: 0.75rem;
			opacity: 0.8;
		}

		.section-title {
			font-size: 1.875rem;
			font-weight: 800;
			font-style: italic;
			letter-spacing: -0.05em;
			margin-bottom: 2.5rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			color: #0f0f11;
		}

		.section-subtitle {
			font-size: 0.875rem;
			font-weight: 400;
			font-style: normal;
			color: #9ca3af;
			margin-left: 1rem;
		}

		/* Featured Carousel */
		.featured-carousel {
			position: relative;
		}

		.carousel-container {
			overflow: hidden;
			width: 100%;
		}

		.carousel-track {
			display: flex;
			transition: transform 0.5s ease-in-out;
			width: 100%;
		}

		.featured-post {
			min-width: 100%;
			max-width: 100%;
			flex-shrink: 0;
			flex-grow: 0;
		}

		.featured-link {
			text-decoration: none;
			color: inherit;
			display: flex;
			flex-direction: column;
			gap: 1.5rem;
		}


		.carousel-dots {
			display: flex;
			justify-content: center;
			gap: 0.5rem;
			margin-top: 1.5rem;
		}

		.carousel-dot {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			border: none;
			background: #d1d5db;
			cursor: pointer;
			transition: all 0.3s ease;
			padding: 0;
		}

		.carousel-dot:hover {
			background: #9ca3af;
		}

		.carousel-dot.active {
			background: #2563eb;
			width: 24px;
			border-radius: 5px;
		}

		.featured-image {
			position: relative;
			width: 100%;
			height: 500px;
			background: #f3f4f6;
			overflow: hidden;
			border-radius: 16px;
			flex-shrink: 0;
		}

		.featured-badge {
			position: absolute;
			top: 1rem;
			left: 1rem;
			background: #2563eb;
			color: #fff;
			padding: 0.375rem 0.875rem;
			border-radius: 6px;
			font-size: 0.625rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			z-index: 10;
		}

		.featured-img,
		.featured-img-placeholder {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.3s ease;
		}

		.featured-img-placeholder {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}

		.featured-post:hover .featured-img {
			transform: scale(1.05);
		}

		.featured-content {
			display: flex;
			flex-direction: column;
			gap: 0.75rem;
		}

		.featured-title {
			font-size: 2rem;
			font-weight: 700;
			line-height: 1.3;
			margin: 0;
			color: #0f0f11;
			transition: color 0.2s ease;
		}

		.featured-post:hover .featured-title {
			color: #2563eb;
		}

		.featured-meta {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			flex-wrap: wrap;
		}

		.featured-date {
			color: #6b7280;
			font-family: 'JetBrains Mono', monospace;
			font-size: 0.875rem;
		}

		.featured-tags {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			align-items: center;
		}

		.featured-tag {
			display: inline-block;
			padding: 0.375rem 0.75rem;
			background: #f3f4f6;
			color: #6b7280;
			border-radius: 6px;
			font-size: 0.8125rem;
			font-weight: 500;
		}

		/* Regular Posts Grid */
		.posts-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 2rem;
			margin-bottom: 3rem;
		}

		.post-card {
			border-radius: 24px;
			border: none;
			background: #fff;
			overflow: hidden;
			transition: all 0.3s ease;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			height: 520px;
			display: flex;
			flex-direction: column;
		}

		.post-card:hover {
			transform: translateY(-6px);
			box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
		}

		.card-link {
			text-decoration: none;
			color: inherit;
			display: flex;
			flex-direction: column;
			height: 100%;
		}

		.card-image {
			width: 100%;
			height: 280px;
			background: #f3f4f6;
			overflow: hidden;
			flex-shrink: 0;
		}

		.card-img,
		.card-img-placeholder {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.3s ease;
		}

		.card-img-placeholder {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}

		.post-card:hover .card-img {
			transform: scale(1.05);
		}

		.card-content {
			padding: 1.75rem;
			display: flex;
			flex-direction: column;
			gap: 0.75rem;
			flex-grow: 1;
		}

		.card-date {
			font-size: 0.875rem;
			color: #9ca3af;
			font-family: 'JetBrains Mono', monospace;
			margin-bottom: 0.25rem;
		}

		.card-title {
			font-size: 1.5rem;
			font-weight: 700;
			line-height: 1.3;
			margin: 0;
			color: #0f0f11;
			transition: color 0.2s ease;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		.post-card:hover .card-title {
			color: #2563eb;
		}

		.card-description {
			font-size: 0.9375rem;
			line-height: 1.6;
			color: #6b7280;
			margin: 0;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
			flex-grow: 1;
		}

		.card-tags {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			margin-top: auto;
		}

		.post-tag {
			display: inline-block;
			padding: 0.375rem 0.75rem;
			background: #f3f4f6;
			color: #6b7280;
			border-radius: 6px;
			font-size: 0.8125rem;
			font-weight: 500;
		}

		/* Pagination */
		.pagination {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 1rem;
			margin-top: 3rem;
		}

		.pagination-btn {
			padding: 0.625rem 1.25rem;
			background: #fff;
			border: 1px solid #e5e7eb;
			border-radius: 8px;
			font-size: 0.875rem;
			font-weight: 500;
			color: #374151;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.pagination-btn:hover:not(:disabled) {
			background: #f9fafb;
			border-color: #d1d5db;
		}

		.pagination-btn:disabled {
			opacity: 0.4;
			cursor: not-allowed;
		}

		.pagination-btn:disabled:hover {
			background: #fff;
			border-color: #e5e7eb;
		}

		.pagination-numbers {
			display: flex;
			gap: 0.5rem;
		}

		.pagination-number {
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #fff;
			border: 1px solid #e5e7eb;
			border-radius: 8px;
			font-size: 0.875rem;
			font-weight: 500;
			color: #374151;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.pagination-number:hover {
			background: #f9fafb;
			border-color: #d1d5db;
		}

		.pagination-number.active {
			background: #2563eb;
			border-color: #2563eb;
			color: #fff;
		}

		@media (max-width: 768px) {
			.featured-image {
				height: 300px;
			}

			.featured-title {
				font-size: 1.5rem;
			}

			.featured-content {
				gap: 0.5rem;
			}


			.posts-grid {
				grid-template-columns: 1fr;
				gap: 1.5rem;
			}

			.post-card {
				height: auto;
			}

			.card-image {
				height: 200px;
			}

			.pagination {
				flex-wrap: wrap;
			}

			.pagination-numbers {
				order: -1;
				width: 100%;
				justify-content: center;
			}
		}
	</style>
</Layout>
